<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização da Arquitetura em Camadas (Fluxo)</title>
    <style>
        body { font-family: sans-serif; margin: 30px; background-color: #f4f4f9; display: flex; gap: 30px; }
        .formulario { flex: 1; max-width: 400px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content; }
        .visualizacao { flex: 2; padding: 20px; background: #e0f7fa; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1); }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; }
        
        /* Estilos do Formulário */
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #mensagem { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; }
        .sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Estilos da Visualização do Fluxo */
        .camada {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 2px solid #ccc;
            transition: all 0.5s ease-in-out;
            opacity: 0.5;
        }
        .camada h4 { margin: 0 0 5px 0; color: #333; }
        .camada p { margin: 0; font-size: 0.9em; color: #666; }

        /* Estilo Dinâmico para Camada Ativa */
        .active-sending { background-color: #38c172; color: white; border-color: #216a3a; transform: scale(1.05); opacity: 1; }
        .active-receiving { background-color: #3490dc; color: white; border-color: #1c5d9a; transform: scale(1.05); opacity: 1; }
        .camada-bd { background-color: #ffed4a; color: #333; border-color: #d1b539; }
        .active-error { background-color: #e3342f; color: white; border-color: #9b211f; transform: scale(1.05); opacity: 1; }

        .fluxo-log { margin-top: 20px; padding: 10px; background-color: #eee; border-radius: 4px; max-height: 200px; overflow-y: auto; }
        .log-item { margin-bottom: 5px; font-size: 0.85em; }
    </style>
</head>
<body>
    
    <div class="formulario">
        <h1>Simulação de Arquitetura</h1>
        <h2>Entrada de Dados (Camada 1: UI)</h2>
        
        <form id="formCadastro">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" required minlength="3">
            
            <label for="cpf">CPF (11 dígitos):</label>
            <input type="text" id="cpf" required maxlength="11" pattern="\d{11}" title="O CPF deve conter exatamente 11 dígitos numéricos.">
            
            <button type="submit" id="btnCadastrar">Cadastrar Cliente</button>
        </form>
        
        <div id="mensagem">Aguardando envio...</div>
    </div>

    <div class="visualizacao">
        <h2>Visualização do Fluxo de Camadas</h2>
        
        <div id="camada-apresentacao" class="camada">
            <h4>Camada 1: Apresentação (UI/Controller)</h4>
            <p>Recebe dados e envia requisição.</p>
        </div>

        <div id="camada-negocio" class="camada">
            <h4>Camada 2: Negócio (Service)</h4>
            <p>Executa validações e regras (O cérebro).</p>
        </div>

        <div id="camada-persistencia" class="camada">
            <h4>Camada 3: Persistência (Repository/DAL)</h4>
            <p>Prepara e executa comandos no BD.</p>
        </div>
        
        <div id="camada-bd" class="camada camada-bd">
            <h4>Camada 4: Banco de Dados (Database)</h4>
            <p>Armazenamento físico dos dados.</p>
        </div>

        <div class="fluxo-log">
            <h4>Logs de Fluxo:</h4>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        // --- FUNÇÕES DE AJUSTE VISUAL ---
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        function logFluxo(mensagem) {
            const logContainer = document.getElementById('log-container');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${mensagem}`;
            logContainer.prepend(logItem); // Adiciona no topo
            console.log(mensagem);
        }

        function destacarCamada(id, tipo = 'active-sending') {
            document.querySelectorAll('.camada').forEach(el => {
                el.classList.remove('active-sending', 'active-receiving', 'active-error');
                el.style.opacity = '0.5';
            });
            const el = document.getElementById(id);
            if (el) {
                el.classList.add(tipo);
                el.style.opacity = '1';
            }
        }

        function resetVisual() {
            document.querySelectorAll('.camada').forEach(el => {
                el.classList.remove('active-sending', 'active-receiving', 'active-error');
                el.style.opacity = '0.5';
            });
            document.getElementById('log-container').innerHTML = '';
        }

        // --- FUNÇÕES DE FLUXO (SIMULAÇÃO DAS CAMADAS) ---
        
        async function simularFluxoDeCamadas(nome, cpf) {
            
            // =========================================================================
            // FLUXO DE IDA (Downstream: Pedido de Cadastro)
            // =========================================================================
            
            logFluxo("REQUISIÇÃO INICIADA: Dados enviados para a API.");
            destacarCamada('camada-apresentacao', 'active-sending');
            await sleep(500);

            // 1. Chegando na Camada de Negócio (Service)
            logFluxo("--> Camada de Negócio: Iniciando validações...");
            destacarCamada('camada-negocio', 'active-sending');
            await sleep(700);

            // VALIDAÇÃO CRÍTICA (Simulação de Erro de Negócio)
            if (!nome || nome.length < 3) {
                logFluxo("!!! ERRO DE NEGÓCIO: Nome inválido. A persistência não será chamada.");
                destacarCamada('camada-negocio', 'active-error');
                return { status: 400, data: { erro: "NEGÓCIO: Nome do cliente inválido ou muito curto." } };
            }
            if (!cpf || cpf.length !== 11 || !/^\d+$/.test(cpf)) {
                 logFluxo("!!! ERRO DE NEGÓCIO: CPF inválido. A persistência não será chamada.");
                destacarCamada('camada-negocio', 'active-error');
                return { status: 400, data: { erro: "NEGÓCIO: CPF inválido. Cadastro negado." } };
            }

            // 2. Chamada à Camada de Persistência (Repository/DAL)
            logFluxo("--> Camada de Persistência: Preparando SQL para o Banco...");
            destacarCamada('camada-persistencia', 'active-sending');
            await sleep(700);

            // 3. Chegando na Camada de Banco de Dados
            logFluxo("--> Camada de Banco de Dados: Executando INSERT...");
            destacarCamada('camada-bd', 'active-sending');
            await sleep(1000); // Simula o tempo de I/O do banco

            // =========================================================================
            // FLUXO DE VOLTA (Upstream: Resposta de Sucesso)
            // =========================================================================
            
            // 4. Retorno do Banco de Dados para Persistência
            logFluxo("<-- Camada de Banco de Dados: Confirmação de INSERT.");
            destacarCamada('camada-bd', 'active-receiving');
            await sleep(500);

            // 5. Retorno para Camada de Negócio
            logFluxo("<-- Camada de Persistência: Dados mapeados. Retornando objeto...");
            destacarCamada('camada-persistencia', 'active-receiving');
            await sleep(500);
            
            // 6. Retorno para o Controller/UI
            logFluxo("<-- Camada de Negócio: Lógica finalizada. Retornando STATUS 201.");
            destacarCamada('camada-negocio', 'active-receiving');
            await sleep(500);

            // Fim do Processo
            logFluxo("REQUISIÇÃO FINALIZADA: Sucesso!");
            return { 
                status: 201, 
                data: { id: Math.floor(Math.random() * 100) + 1, nome: nome, cpf: cpf } 
            };
        }


        // --- LÓGICA DO FORMULÁRIO ---

        document.getElementById('formCadastro').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            const mensagemDiv = document.getElementById('mensagem');
            
            mensagemDiv.textContent = 'Processando... Veja o Fluxo ao lado.';
            mensagemDiv.className = '';
            document.getElementById('btnCadastrar').disabled = true;
            resetVisual();

            const resposta = await simularFluxoDeCamadas(nome, cpf);

            // --- TRATAMENTO DO RETORNO ---
            document.getElementById('btnCadastrar').disabled = false;
            destacarCamada('camada-apresentacao', resposta.status === 201 ? 'active-receiving' : 'active-error');


            if (resposta.status === 201) {
                mensagemDiv.textContent = `Sucesso! Cliente cadastrado: ${resposta.data.nome} (ID: ${resposta.data.id})`;
                mensagemDiv.classList.add('sucesso');
                document.getElementById('formCadastro').reset();
            } else if (resposta.status === 400) {
                mensagemDiv.textContent = `Erro de Validação: ${resposta.data.erro}`;
                mensagemDiv.classList.add('erro');
            }
            
            await sleep(2000);
            resetVisual();
        });
    </script>
</body>
</html>