<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Arquitetura em Camadas (Estrada)</title>
    <style>
        body { font-family: sans-serif; margin: 30px; background-color: #f4f4f9; display: flex; gap: 30px; }
        .formulario { flex: 1; max-width: 400px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content; }
        .visualizacao { flex: 2; padding: 20px; background: #e0f7fa; border-radius: 8px; position: relative; min-height: 950px; } /* Relativo para posicionar as setas */
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; }
        
        /* Estilos do Formul√°rio */
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #mensagem { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; }
        .sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Estilos da Visualiza√ß√£o do Fluxo */
        .camada-box {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 100px; /* Mant√©m o espa√ßamento de 50px */
            border-radius: 6px;
            border: 2px solid #ccc;
            transition: all 0.3s ease-in-out;
            position: relative;
            z-index: 10; 
            min-height: 90px; /* Altura m√≠nima para fixar o tamanho e estabilizar o layout */
        }
        .camada-box h4 { margin: 0 0 5px 0; color: #333; }
        .camada-box p { margin: 0; font-size: 0.9em; color: #666; }
        .camada-box.active { border-color: #28a745; box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); transform: scale(1.02); }
        .camada-box.error { border-color: #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.5); transform: scale(1.02); }

        /* Estilo da Estrada (Setas) */
        .caminho-seta {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 50px; /* Largura da "estrada" */
            text-align: center;
            padding: 5px 0;
            z-index: 5;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            background-color: transparent;
            transition: background-color 0.5s ease-in-out, height 0.5s ease-in-out;
        }

        /* AJUSTE FINAL DO POSICIONAMENTO DAS SETAS */
        /* AJUSTE FINAL E FORTE DO POSICIONAMENTO DAS SETAS */
        #seta-1-2 { top: 185px; height: 100px; } /* Altura da estrada agora √© 100px */
        #seta-2-3 { top: 385px; height: 100px; } /* Rec√°lculo de TOP */
        #seta-3-4 { top: 595px; height: 100px; } /* Rec√°lculo de TOP */
        
        .seta-ida {
            background-color: #28a745; /* Verde: Requisi√ß√£o de Ida */
            animation: pulse-ida 1s infinite alternate;
        }
        .seta-volta {
            background-color: #007bff; /* Azul: Resposta de Volta */
            animation: pulse-volta 1s infinite alternate;
        }

        @keyframes pulse-ida {
            from { box-shadow: 0 0 0 rgba(40, 167, 69, 0.4); }
            to { box-shadow: 0 0 10px rgba(40, 167, 69, 1); }
        }
        @keyframes pulse-volta {
            from { box-shadow: 0 0 0 rgba(0, 123, 255, 0.4); }
            to { box-shadow: 0 0 10px rgba(0, 123, 255, 1); }
        }
        /* Estilo para o √çcone/Pacote */
        .caminho-seta::after {
            content: ''; /* √çcone ser√° inserido via JS */
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px; /* Tamanho do √≠cone */
            z-index: 20; /* Garante que fique acima da seta */
            opacity: 0; /* Come√ßa invis√≠vel */
            transition: opacity 0.5s;
        }

        /* Anima√ß√£o para o √çCONE de IDA (descendo) */
        @keyframes mover-ida {
            0% { transform: translate(-50%, -10px); opacity: 1; }
            100% { transform: translate(-50%, 110px); opacity: 1; } /* Desce 110px */
        }

        /* Anima√ß√£o para o √çCONE de VOLTA (subindo) */
        @keyframes mover-volta {
            0% { transform: translate(-50%, 110px); opacity: 1; }
            100% { transform: translate(-50%, -10px); opacity: 1; } /* Sobe */
        }

        .animar-ida::after {
            content: 'üì¶'; /* √çcone do Pacote de Ida */
            animation: mover-ida 1s linear forwards;
        }

        .animar-volta::after {
            content: '‚úÖ'; /* √çcone de Confirma√ß√£o/Resposta de Volta */
            animation: mover-volta 1s linear forwards;
        }

        /* Ajustes no caminho da seta para que a anima√ß√£o n√£o se repita */
        .seta-ida {
            background-color: #28a745; 
            animation: none; /* Remove a anima√ß√£o de pulsa√ß√£o da pr√≥pria seta */
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); /* Mant√©m a sombra fixa */
        }
        .seta-volta {
            background-color: #007bff; 
            animation: none; /* Remove a anima√ß√£o de pulsa√ß√£o da pr√≥pria seta */
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); /* Mant√©m a sombra fixa */
        }

        .fluxo-log { margin-top: 40px; padding: 10px; background-color: #eee; border-radius: 4px; max-height: 200px; overflow-y: auto; }
        .log-item { margin-bottom: 5px; font-size: 0.85em; }
    </style>
</head>
<body>
    
    <div class="formulario">
        <h1>Simulador de Arquitetura</h1>
        <h2>Entrada de Dados (Camada 1: UI)</h2>
        
        <form id="formCadastro">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" required minlength="3">
            
            <label for="cpf">CPF (11 d√≠gitos):</label>
            <input type="text" id="cpf" required maxlength="11" pattern="\d{11}" title="O CPF deve conter exatamente 11 d√≠gitos num√©ricos.">
            
            <button type="submit" id="btnCadastrar">Cadastrar Cliente</button>
        </form>
        
        <div id="mensagem">Aguardando envio...</div>
    </div>

    <div class="visualizacao">
        <h2>Visualiza√ß√£o do Fluxo de Camadas</h2>
        
        <div id="camada-1" class="camada-box">
            <h4>Camada 1: Apresenta√ß√£o (UI/Controller)</h4>
            <p id="status-1">Aguardando dados...</p>
        </div>

        <div id="seta-1-2" class="caminho-seta"></div>

        <div id="camada-2" class="camada-box">
            <h4>Camada 2: Neg√≥cio (Service)</h4>
            <p id="status-2">Regras de neg√≥cio e valida√ß√£o.</p>
        </div>
        
        <div id="seta-2-3" class="caminho-seta"></div>

        <div id="camada-3" class="camada-box">
            <h4>Camada 3: Persist√™ncia (Repository/DAL)</h4>
            <p id="status-3">Prepara comandos SQL/ORM.</p>
        </div>
        
        <div id="seta-3-4" class="caminho-seta"></div>

        <div id="camada-4" class="camada-box" style="background-color: #fff3cd; border-color: #ffe082;">
            <h4>Camada 4: Banco de Dados (Database)</h4>
            <p id="status-4">Armazenamento f√≠sico.</p>
        </div>

        <div class="fluxo-log">
            <h4>Logs de Fluxo:</h4>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        // --- FUN√á√ïES AUXILIARES ---
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        
        function logFluxo(mensagem) {
            const logContainer = document.getElementById('log-container');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `[${new Date().toLocaleTimeString()}] ${mensagem}`;
            logContainer.prepend(logItem);
            // Limitador b√°sico para evitar excesso de logs
            if (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
            console.log(mensagem);
        }

        // FUN√á√ÉO ATUALIZADA (usa o n√∫mero da camada)
        function atualizarStatus(camadaNum, mensagem, tipo = 'normal') {
            const camadaId = `camada-${camadaNum}`; // Monta o ID da caixa da camada (ex: camada-1)
            const statusId = `status-${camadaNum}`; // Monta o ID do status interno (ex: status-1)
            
            // 1. Atualiza o texto de status
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                 statusElement.textContent = mensagem;
            }

            // 2. Atualiza o estilo visual da caixa da camada
            const element = document.getElementById(camadaId);
            if (element) {
                element.classList.remove('active', 'error');
                if (tipo === 'active') element.classList.add('active');
                if (tipo === 'error') element.classList.add('error');
            }
        }

        function atualizarSeta(setaId, tipo) {
            const seta = document.getElementById(setaId);
            
            // Remove as classes de fluxo e anima√ß√£o
            seta.classList.remove('seta-ida', 'seta-volta', 'animar-ida', 'animar-volta');
            seta.innerHTML = '';

            if (tipo === 'ida') {
                seta.classList.add('seta-ida', 'animar-ida');
                seta.innerHTML = 'REQUISI√á√ÉO ‚Üì';
            } else if (tipo === 'volta') {
                seta.classList.add('seta-volta', 'animar-volta');
                seta.innerHTML = 'RESPOSTA ‚Üë';
            }
        }

        function resetVisual() {
            document.querySelectorAll('.camada-box').forEach(el => el.classList.remove('active', 'error'));
            document.querySelectorAll('.caminho-seta').forEach(el => { el.classList.remove('seta-ida', 'seta-volta'); el.innerHTML = ''; });
            document.getElementById('log-container').innerHTML = '';
            // Usa a fun√ß√£o corrigida para resetar os textos
            atualizarStatus('1', 'Aguardando dados...');
            atualizarStatus('2', 'Regras de neg√≥cio e valida√ß√£o.');
            atualizarStatus('3', 'Prepara comandos SQL/ORM.');
            atualizarStatus('4', 'Armazenamento f√≠sico.');
        }

        // --- FLUXO PRINCIPAL (SIMULA√á√ÉO DAS CAMADAS) ---
        
        async function simularFluxoDeCamadas(nome, cpf) {
            
            // -------------------------------------------------------------------------
            // FLUXO DE IDA (Downstream: Pedido de Cadastro)
            // -------------------------------------------------------------------------
            
            logFluxo("‚ñ∂Ô∏è IN√çCIO: Requisi√ß√£o capturada na Camada de Apresenta√ß√£o.");
            atualizarStatus('1', 'Capturado. Partindo para Neg√≥cio...', 'active');
            await sleep(500);

            // Ida 1-2
            atualizarSeta('seta-1-2', 'ida');
            await sleep(1000);

            // Camada 2: Neg√≥cio (Service)
            atualizarSeta('seta-1-2', '');
            atualizarStatus('2', 'CHEGANDO. Iniciando valida√ß√µes...', 'active');
            logFluxo("2Ô∏è‚É£ Neg√≥cio: Chegou. Validando dados...");
            await sleep(1500);

            // VALIDA√á√ÉO CR√çTICA (Simula√ß√£o de Erro de Neg√≥cio)
            if (!nome || nome.length < 3 || !cpf || cpf.length !== 11 || !/^\d+$/.test(cpf)) {
                logFluxo("‚ùå ERRO DE NEG√ìCIO: Valida√ß√£o falhou. Retorno imediato.");
                atualizarStatus('2', 'ERRO! Retornando resposta 400.', 'error');
                await sleep(500);
                
                // Volta do Erro
                atualizarSeta('seta-1-2', 'volta');
                await sleep(1000);
                
                logFluxo("‚Ü©Ô∏è FIM (ERRO): Resposta 400 devolvida √† Apresenta√ß√£o.");
                return { status: 400, data: { erro: "Nome ou CPF inv√°lido (regra de neg√≥cio)." } };
            }

            // Partida 2-3
            atualizarStatus('2', 'Valida√ß√µes OK. Partindo para Persist√™ncia...', 'active');
            atualizarSeta('seta-2-3', 'ida');
            await sleep(1000);

            // Camada 3: Persist√™ncia (Repository/DAL)
            atualizarSeta('seta-2-3', '');
            atualizarStatus('3', 'CHEGANDO. Preparando comando SQL...', 'active');
            logFluxo("3Ô∏è‚É£ Persist√™ncia: Chegou. Preparando para salvar...");
            await sleep(1000);

            // Partida 3-4
            atualizarStatus('3', 'Comando SQL pronto. Partindo para o Banco de Dados...', 'active');
            atualizarSeta('seta-3-4', 'ida');
            await sleep(1000);

            // Camada 4: Banco de Dados
            atualizarSeta('seta-3-4', '');
            atualizarStatus('4', 'CHEGANDO. Executando I/O...', 'active');
            logFluxo("4Ô∏è‚É£ Banco de Dados: Salvando registro...");
            await sleep(1500); 

            // -------------------------------------------------------------------------
            // FLUXO DE VOLTA (Upstream: Resposta de Sucesso)
            // -------------------------------------------------------------------------
            
            logFluxo("‚¨ÜÔ∏è VOLTA INICIADA: Sucesso no Banco de Dados.");
            
            // Volta 4-3
            atualizarStatus('4', 'Sucesso! Retornando resultado.', 'active');
            atualizarSeta('seta-3-4', 'volta');
            await sleep(1000);
            
            // Camada 3: Persist√™ncia
            atualizarSeta('seta-3-4', '');
            atualizarStatus('3', 'CHEGANDO. Mapeando resultado...', 'active');
            logFluxo("3Ô∏è‚É£ Persist√™ncia: Mapeamento conclu√≠do.");
            await sleep(500);
            
            // Volta 3-2
            atualizarStatus('3', 'Pronto. Partindo para Neg√≥cio...', 'active');
            atualizarSeta('seta-2-3', 'volta');
            await sleep(1000);

            // Camada 2: Neg√≥cio
            atualizarSeta('seta-2-3', '');
            atualizarStatus('2', 'CHEGANDO. L√≥gica finalizada.', 'active');
            logFluxo("2Ô∏è‚É£ Neg√≥cio: Requisi√ß√£o OK. Preparando resposta final.");
            await sleep(500);

            // Volta 2-1
            atualizarStatus('2', 'Pronto. Partindo para Apresenta√ß√£o...', 'active');
            atualizarSeta('seta-1-2', 'volta');
            await sleep(1000);

            // Fim do Processo
            atualizarSeta('seta-1-2', '');
            atualizarStatus('1', 'Resposta recebida. Sucesso.', 'active');
            logFluxo("‚úÖ FIM (SUCESSO): Resposta 201 devolvida ao usu√°rio.");

            return { 
                status: 201, 
                data: { id: Math.floor(Math.random() * 100) + 1, nome: nome, cpf: cpf } 
            };
        }

        // --- L√ìGICA DO FORMUL√ÅRIO (CHAMA O FLUXO) ---

        document.getElementById('formCadastro').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            const mensagemDiv = document.getElementById('mensagem');
            
            mensagemDiv.textContent = 'Processando... Veja o Fluxo ao lado.';
            mensagemDiv.className = '';
            document.getElementById('btnCadastrar').disabled = true;
            resetVisual();
            
            const resposta = await simularFluxoDeCamadas(nome, cpf);

            // TRATAMENTO DO RETORNO E FINALIZA√á√ÉO
            document.getElementById('btnCadastrar').disabled = false;
            
            if (resposta.status === 201) {
                mensagemDiv.textContent = `Sucesso! Cliente cadastrado: ${resposta.data.nome}`;
                mensagemDiv.classList.add('sucesso');
                document.getElementById('formCadastro').reset();
            } else if (resposta.status === 400) {
                mensagemDiv.textContent = `Erro de Valida√ß√£o: ${resposta.data.erro}`;
                mensagemDiv.classList.add('erro');
            }
            
            await sleep(2000);
            resetVisual();
        });
    </script>
</body>
</html>